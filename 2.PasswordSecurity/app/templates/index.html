<!doctype html>
<html>
    <head>
        <title>Login Portal</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 500px;
                margin: 50px auto;
                padding: 20px;
                background-color: #f0f0f0;
            }
            .container {
                background-color: white;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            h1 {
                color: #333;
                text-align: center;
            }
            .form-group {
                margin-bottom: 15px;
            }
            label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #555;
            }
            input[type="text"],
            input[type="password"] {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }
            button {
                width: 100%;
                padding: 12px;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 10px;
            }
            .btn-login {
                background-color: #007bff;
            }
            .btn-login:hover {
                background-color: #0056b3;
            }
            .btn-logout {
                background-color: #dc3545;
            }
            .btn-logout:hover {
                background-color: #c82333;
            }
            .info {
                background-color: #e7f3ff;
                padding: 10px;
                border-left: 4px solid #007bff;
                margin-top: 20px;
                font-size: 14px;
            }
            #result {
                margin-top: 20px;
                padding: 15px;
                border-radius: 4px;
                display: none;
            }
            .success {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }
            .error {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
            .flag {
                font-family: monospace;
                font-weight: bold;
                background-color: #fff3cd;
                padding: 10px;
                margin-top: 10px;
                border-radius: 4px;
                word-break: break-all;
            }
            .hidden {
                display: none;
            }
            #loggedInSection {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1 id="pageTitle">{{TITLE}}</h1>

            <!-- Login Form Section -->
            <div id="loginSection" class="{{LOGIN_HIDDEN}}">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username:</label>
                        <input
                            type="text"
                            id="username"
                            name="username"
                            required
                        />
                    </div>

                    <div class="form-group">
                        <label for="password">Password:</label>
                        <input
                            type="password"
                            id="password"
                            name="password"
                            required
                        />
                    </div>

                    <button type="submit" class="btn-login">Login</button>
                </form>

                <div id="result"></div>

                <div class="info">
                    <strong>Note:</strong> Use your username and password to
                    login.
                </div>
            </div>

            <!-- Logged In Section -->
            <div id="loggedInSection" class="{{LOGGED_IN_HIDDEN}}">
                <div class="success">
                    <strong>You are logged in!</strong>
                    <div class="flag" id="flagDisplay">ðŸš© Loading...</div>
                </div>

                <button onclick="logout()" class="btn-logout">Logout</button>
            </div>
        </div>

        <script>
            async function fetchFlag() {
                try {
                    const response = await fetch("/flag");
                    const result = await response.json();
                    const flagDisplay = document.getElementById("flagDisplay");
                    if (result.success && result.flag) {
                        flagDisplay.textContent = "ðŸš© " + result.flag;
                    } else {
                        flagDisplay.textContent = "ðŸš© Unable to fetch flag";
                    }
                } catch (error) {
                    console.error("Flag fetch error:", error);
                }
            }

            if (
                !document
                    .getElementById("loggedInSection")
                    .classList.contains("hidden")
            ) {
                fetchFlag();
            }

            async function logout() {
                try {
                    await fetch("/logout", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded",
                        },
                    });
                } catch (error) {
                    console.error("Logout error:", error);
                }
                // Clear cookie and reload
                document.cookie =
                    "session_token=; Max-Age=0; Path=/; SameSite=Lax";
                location.reload();
            }

            document
                .getElementById("loginForm")
                ?.addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const formData = new FormData(e.target);
                    const data = {};

                    for (let [key, value] of formData.entries()) {
                        if (value) data[key] = value;
                    }

                    try {
                        const response = await fetch("/login", {
                            method: "POST",
                            headers: {
                                "Content-Type":
                                    "application/x-www-form-urlencoded",
                            },
                            body: new URLSearchParams(data),
                        });

                        const result = await response.json();

                        if (result.success) {
                            location.reload();
                        } else {
                            // Show error or success message
                            const resultDiv = document.getElementById("result");
                            resultDiv.style.display = "block";
                            resultDiv.className = result.success
                                ? "success"
                                : "error";
                            resultDiv.innerHTML = `<strong>${result.message}</strong>`;
                        }
                    } catch (error) {
                        const resultDiv = document.getElementById("result");
                        resultDiv.style.display = "block";
                        resultDiv.className = "error";
                        resultDiv.innerHTML =
                            "<strong>Error: Could not connect to server</strong>";
                    }
                });
        </script>
    </body>
</html>
